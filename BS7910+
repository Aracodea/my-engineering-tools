<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BS 7910:2019 Professional Integrity Analyst</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root {
            --header-bg: #1e272e;
            --panel-bg: #ffffff;
            --bg-color: #f1f2f6;
            --accent: #0984e3;
            --text-main: #2d3436;
            --text-light: #636e72;
            --border: #dfe6e9;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
        }

        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: var(--header-bg); color: white; padding: 0 20px; height: 50px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        h1 { font-size: 1.1rem; margin: 0; font-weight: 600; letter-spacing: 0.5px; }
        .tabs button { background: none; border: none; color: #b2bec3; padding: 0 15px; height: 50px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .tabs button.active { color: white; border-bottom: 3px solid var(--accent); }

        /* LAYOUT */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* TOP: RESULTS DASHBOARD */
        .dashboard {
            background: white; border-bottom: 1px solid var(--border);
            padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
            height: 70px; flex-shrink: 0;
        }
        .status-box { display: flex; align-items: center; gap: 15px; }
        .badge { padding: 5px 12px; border-radius: 4px; color: white; font-weight: bold; font-size: 1rem; text-transform: uppercase; }
        .badge.pass { background: var(--success); }
        .badge.fail { background: var(--danger); }
        
        .kpi-group { display: flex; gap: 30px; }
        .kpi { display: flex; flex-direction: column; }
        .kpi label { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; }
        .kpi val { font-family: 'Consolas', monospace; font-size: 1.1rem; color: var(--header-bg); font-weight: 600; }
        .kpi-sub { font-size: 0.75rem; color: var(--accent); font-weight: 600; margin-top: 2px; }

        /* MIDDLE: PLOTS */
        .plots-area {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 10px;
            background: #dfe6e9; min-height: 0;
        }
        .plot-panel { background: white; border-radius: 4px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .plot-title { font-size: 0.8rem; font-weight: 700; color: var(--text-light); padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .plot-canvas { flex: 1; position: relative; }

        /* BOTTOM: INPUTS */
        .inputs-area { height: 380px; background: white; border-top: 1px solid var(--border); display: flex; flex-shrink: 0; }
        
        /* Sidebar Navigation */
        .cat-sidebar { width: 160px; background: #2d3436; display: flex; flex-direction: column; }
        .cat-btn {
            background: none; border: none; color: #b2bec3; padding: 15px; text-align: left;
            cursor: pointer; border-left: 3px solid transparent; font-size: 0.9rem;
        }
        .cat-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .cat-btn.active { background: #353b48; color: white; border-left-color: var(--accent); font-weight: 600; }

        /* Input Content */
        .input-content { flex: 1; display: flex; }
        .input-scroll { flex: 2; padding: 20px; overflow-y: auto; }
        
        /* Category Sections */
        .cat-section { display: none; }
        .cat-section.active { display: block; }
        
        /* Parameter Row */
        .param-row { margin-bottom: 25px; border-bottom: 1px dashed var(--border); padding-bottom: 15px; }
        .param-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .param-label { font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .param-val { font-family: 'Consolas', monospace; color: var(--accent); font-weight: bold; }
        
        .slider-container { display: flex; align-items: center; gap: 10px; }
        input[type=range] { flex: 1; cursor: pointer; accent-color: var(--accent); }
        
        /* Dropdown Info Button */
        .info-btn {
            background: #dfe6e9; border: none; color: var(--text-light); width: 24px; height: 24px;
            border-radius: 50%; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .info-btn:hover { background: var(--accent); color: white; }

        /* Dropdown Info Box */
        .info-panel {
            display: none; background: #f8f9fa; border: 1px solid #e1e1e1; border-left: 3px solid var(--accent);
            padding: 10px; margin-top: 10px; font-size: 0.85rem; color: #444; border-radius: 0 4px 4px 0;
        }
        .info-panel.visible { display: block; animation: slideDown 0.2s ease-out; }
        .formula { background: white; padding: 5px; margin: 5px 0; border: 1px solid #eee; text-align: center; }

        @keyframes slideDown { from {opacity:0; transform:translateY(-5px);} to {opacity:1; transform:translateY(0);} }

        /* Configuration Dropdown */
        .config-select { width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; }

        /* About Tab */
        .about-view { display: none; padding: 40px; overflow-y: auto; max-width: 800px; margin: 0 auto; }
        .about-view.active { display: block; }
        .about-view h2 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; }

    </style>
</head>
<body>

<header>
    <h1>BS 7910 INTEGRITY SUITE</h1>
    <div class="tabs">
        <button onclick="switchView('tool')" class="active">Assessment Tool</button>
        <button onclick="switchView('about')">Guidelines & Theory</button>
    </div>
</header>

<div class="main-container">

    <div id="view-tool" style="display:flex; flex-direction:column; height:100%;">
        
        <div class="dashboard">
            <div class="status-box">
                <div id="status-badge" class="badge pass">PASS</div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:700; font-size:0.9rem;" id="status-text">ACCEPTABLE</span>
                    <span style="font-size:0.75rem; color:var(--text-light);">Level 2A Assessment</span>
                </div>
            </div>
            
            <div class="kpi-group">
                <div class="kpi">
                    <label>Plastic Collapse (Lr)</label>
                    <val id="kpi-lr">0.45</val>
                    <div class="kpi-sub">Limit: 1.50</div>
                </div>
                <div class="kpi">
                    <label>Fracture Ratio (Kr)</label>
                    <val id="kpi-kr">0.32</val>
                    <div class="kpi-sub" id="kpi-kr-lim">Limit: 0.98</div>
                </div>
                <div class="kpi">
                    <label>Remaining Life</label>
                    <val id="kpi-life">1.2M cyc</val>
                    <div class="kpi-sub" id="kpi-next-insp">Insp: 600k cyc</div>
                </div>
            </div>
        </div>

        <div class="plots-area">
            <div class="plot-panel">
                <div class="plot-title">
                    <span>FAILURE ASSESSMENT DIAGRAM (FAD)</span>
                    <span style="font-size:0.7rem; color:#aaa;">BS 7910 Level 2</span>
                </div>
                <div id="plot-fad" class="plot-canvas"></div>
            </div>
            <div class="plot-panel">
                <div class="plot-title">
                    <span>CRACK DEPTH EVOLUTION</span>
                    <span style="font-size:0.7rem; color:#aaa;">Integration a vs N</span>
                </div>
                <div id="plot-life" class="plot-canvas"></div>
            </div>
            <div class="plot-panel">
                <div class="plot-title">
                    <span>CRACK GROWTH RATE</span>
                    <span style="font-size:0.7rem; color:#aaa;">da/dN vs ΔK (Log-Log)</span>
                </div>
                <div id="plot-rate" class="plot-canvas"></div>
            </div>
        </div>

        <div class="inputs-area">
            <div class="cat-sidebar">
                <button class="cat-btn active" onclick="switchCat('geo', this)">Geometry</button>
                <button class="cat-btn" onclick="switchCat('mat', this)">Material</button>
                <button class="cat-btn" onclick="switchCat('load', this)">Loading</button>
                <button class="cat-btn" onclick="switchCat('fat', this)">Fatigue Law</button>
            </div>
            
            <div class="input-content">
                <div class="input-scroll">
                    
                    <div id="cat-geo" class="cat-section active">
                        <div style="margin-bottom:20px;">
                            <label style="font-size:0.8rem; font-weight:700; color:#636e72;">ASSESSMENT CONFIGURATION</label>
                            <select class="config-select" id="cfg-level" onchange="update()">
                                <option value="2">Level 2 (Plasticity Corrected)</option>
                                <option value="1">Level 1 (Simplified Conservative)</option>
                            </select>
                        </div>

                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Wall Thickness (t)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-t">20.0 mm</span>
                                    <button class="info-btn" onclick="toggleInfo('info-t')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-t" min="5" max="100" step="0.5" value="20" oninput="update()">
                            </div>
                            <div id="info-t" class="info-panel">
                                <strong>Description:</strong> The thickness of the plate component.<br>
                                <strong>Relevance:</strong> Affects the constraint (Plane Stress vs Plane Strain) and the Reference Stress calculation.<br>
                                <strong>Constraint Check:</strong> If $t < 2.5(K_{mat}/\sigma_y)^2$, validity is limited.
                            </div>
                        </div>

                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Crack Depth (a)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-a">3.0 mm</span>
                                    <button class="info-btn" onclick="toggleInfo('info-a')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-a" min="0.1" max="50" step="0.1" value="3.0" oninput="update()">
                            </div>
                            <div id="info-a" class="info-panel">
                                <strong>Description:</strong> The depth of the semi-elliptical surface flaw penetrating into the thickness.<br>
                                <strong>Formula (SIF):</strong> $K_I = Y\sigma\sqrt{\pi a}$<br>
                                <strong>Limit:</strong> Cannot exceed thickness $t$.
                            </div>
                        </div>

                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Surface Length (2c)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-2c">20.0 mm</span>
                                    <button class="info-btn" onclick="toggleInfo('info-2c')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-2c" min="1" max="200" step="1" value="20" oninput="update()">
                            </div>
                            <div id="info-2c" class="info-panel">
                                <strong>Description:</strong> The total length of the flaw along the surface.<br>
                                <strong>Aspect Ratio ($a/c$):</strong> Determines the shape factor $Q$ in the Newman-Raju solution. Long cracks ($a/c \to 0$) are more severe.
                            </div>
                        </div>
                    </div>

                    <div id="cat-mat" class="cat-section">
                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Yield Strength ($\sigma_y$)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-sigy">355 MPa</span>
                                    <button class="info-btn" onclick="toggleInfo('info-sigy')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-sigy" min="200" max="900" step="5" value="355" oninput="update()">
                            </div>
                            <div id="info-sigy" class="info-panel">
                                <strong>Description:</strong> The 0.2% proof strength or lower yield strength.<br>
                                <strong>Role:</strong> Denominator for $L_r$. Higher yield strength reduces risk of plastic collapse but may not improve brittle fracture resistance.
                            </div>
                        </div>

                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Fracture Toughness ($K_{mat}$)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-kmat">150 MPa√m</span>
                                    <button class="info-btn" onclick="toggleInfo('info-kmat')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-kmat" min="30" max="400" step="5" value="150" oninput="update()">
                            </div>
                            <div id="info-kmat" class="info-panel">
                                <strong>Description:</strong> Critical stress intensity factor (CTOD converted or $K_{IC}$).<br>
                                <strong>Role:</strong> Denominator for $K_r$. Resists brittle fracture.<br>
                                <strong>Formula:</strong> $K_r = K_I / K_{mat}$
                            </div>
                        </div>
                    </div>

                    <div id="cat-load" class="cat-section">
                         <div style="margin-bottom:20px;">
                            <label style="font-size:0.8rem; font-weight:700; color:#636e72;">STRESS TYPE</label>
                            <select class="config-select">
                                <option>Membrane (Tension)</option>
                                <option disabled>Bending (Not active in demo)</option>
                            </select>
                        </div>

                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Primary Membrane ($\sigma_m$)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-sigm">120 MPa</span>
                                    <button class="info-btn" onclick="toggleInfo('info-sigm')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-sigm" min="0" max="600" step="5" value="120" oninput="update()">
                            </div>
                            <div id="info-sigm" class="info-panel">
                                <strong>Description:</strong> Load-controlled stress (e.g., pressure).<br>
                                <strong>Effect:</strong> Contributes to both $L_r$ (Collapse) and $K_r$ (Fracture). Does not relax with plasticity.
                            </div>
                        </div>

                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Residual Stress ($\sigma_{res}$)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-sigres">50 MPa</span>
                                    <button class="info-btn" onclick="toggleInfo('info-sigres')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-sigres" min="0" max="600" step="5" value="50" oninput="update()">
                            </div>
                            <div id="info-sigres" class="info-panel">
                                <strong>Description:</strong> Secondary stress from welding.<br>
                                <strong>BS 7910 Rule:</strong> Contributes to $K_r$ but <u>NOT</u> to $L_r$ (assuming it relaxes).<br>
                                <strong>Formula:</strong> $K_{total} = K_I^p + K_I^s$
                            </div>
                        </div>
                    </div>
                    
                    <div id="cat-fat" class="cat-section">
                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Stress Range ($\Delta \sigma$)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-dsig">50 MPa</span>
                                    <button class="info-btn" onclick="toggleInfo('info-dsig')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-dsig" min="10" max="400" step="1" value="50" oninput="update()">
                            </div>
                            <div id="info-dsig" class="info-panel">
                                <strong>Description:</strong> The difference between Max and Min stress in a cycle.<br>
                                <strong>Role:</strong> The driving force for crack growth ($\Delta K$).<br>
                                <strong>Formula:</strong> $\Delta K = Y \Delta \sigma \sqrt{\pi a}$
                            </div>
                        </div>
                        
                        <div class="param-row">
                            <div class="param-header">
                                <span class="param-label">Paris Exponent ($m$)</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="param-val" id="disp-m">3.00</span>
                                    <button class="info-btn" onclick="toggleInfo('info-m')">?</button>
                                </div>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="in-m" min="2.0" max="4.0" step="0.05" value="3.0" oninput="update()">
                            </div>
                            <div id="info-m" class="info-panel">
                                <strong>Description:</strong> Slope of the log-log growth curve.<br>
                                <strong>Standard Values:</strong> Steel $\approx 3.0$, Aluminum $\approx 3-4$. High sensitivity: small changes in $m$ cause large life changes.
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="view-about" class="about-view">
        <h2>Guidelines for Usage (BS 7910)</h2>
        <p>This application mimics a <strong>Level 2A Engineering Critical Assessment (ECA)</strong>.</p>
        
        <h3>1. Inputs & Categorisation</h3>
        <ul>
            <li><strong>Geometry:</strong> Use "Geometry" tab to define the flaw ($a$, $2c$) and component ($t$, $W$). Ensure $a < t$.</li>
            <li><strong>Material:</strong> Define $\sigma_y$ and $K_{mat}$. Conservative values should be used (e.g., lower bound).</li>
            <li><strong>Loading:</strong> $\sigma_m$ is primary (load-controlled). $\sigma_{res}$ is secondary (displacement-controlled).</li>
        </ul>
        
        <h3>2. Formulas Used</h3>
        <p><strong>FAD Level 2 Equation:</strong></p>
        <div class="formula">
            $$K_r = (1 - 0.14L_r^2) \times [0.3 + 0.7\exp(-0.65L_r^6)]$$
        </div>
        
        <p><strong>Reference Stress (Flat Plate):</strong></p>
        <div class="formula">
            $$\sigma_{ref} = \frac{\sigma_m}{1 - (a \cdot c / t \cdot W)}$$
        </div>
        
        <h3>3. Interpretation of Results</h3>
        <ul>
            <li><strong>PASS:</strong> The assessment point $(L_r, K_r)$ is inside the curve.</li>
            <li><strong>FAIL:</strong> The point is outside. Failure is predicted.</li>
            <li><strong>Next Inspection:</strong> Calculated as the cycles to reach 50% of the calculated remaining life.</li>
        </ul>
        
        <p><em>Disclaimer: This tool is for educational demonstration only. Do not use for safety-critical components.</em></p>
    </div>

</div>

<script>
    // --- GLOBAL STATE ---
    const s = {
        t: 20, W: 200, a: 3.0, c: 10,
        sigy: 355, kmat: 150,
        sigm: 120, sigres: 50,
        dsig: 50, m: 3.0, C: 1.5e-11, dkth: 2.0
    };

    // --- INIT ---
    window.onload = function() {
        initPlotly();
        update();
        // MathJax typeset
        if(window.MathJax) MathJax.typeset();
    };

    // --- UI CONTROLLERS ---
    function switchView(id) {
        document.getElementById('view-tool').style.display = (id === 'tool') ? 'flex' : 'none';
        document.getElementById('view-about').style.display = (id === 'about') ? 'block' : 'none';
        // Resize plots if showing tool
        if(id === 'tool') setTimeout(() => { Plotly.Plots.resize('plot-fad'); Plotly.Plots.resize('plot-life'); Plotly.Plots.resize('plot-rate'); }, 10);
    }

    function switchCat(catId, btn) {
        document.querySelectorAll('.cat-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.cat-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('cat-' + catId).classList.add('active');
        btn.classList.add('active');
    }

    function toggleInfo(id) {
        const el = document.getElementById(id);
        el.classList.toggle('visible');
    }

    // --- ENGINEERING ENGINE ---

    // 1. Newman-Raju Geometry Factor (Simplified for Demo)
    function calcY(a, c, t, W) {
        if(a <= 0) return 0;
        let at = a / t;
        let ac = a / c;
        let phi = Math.PI / 2; // Deepest point
        
        // Shape Factor Q
        let Q = 1 + 1.464 * Math.pow(ac, 1.65);
        
        // M factors (Newman Raju)
        let M1 = 1.13 - 0.09*at;
        let M2 = -0.54 + 0.89/(0.2+at);
        let M3 = 0.5 - 1/(0.65+at) + 14*Math.pow(1-at, 24);
        let g = 1 + (0.1 + 0.35*(at*at)) * Math.pow(1 - Math.sin(phi), 2);
        
        // FW (Finite Width Correction)
        let fw = Math.sqrt(1/Math.cos((Math.PI*c/W)*Math.sqrt(at))); // Approx

        let Y = (M1 + M2*Math.pow(at, 2) + M3*Math.pow(at, 4)) * g * fw / Math.sqrt(Q);
        return Math.max(0.1, Y); // Clamp
    }

    // 2. FAD Curve (BS 7910 Level 2A)
    function getFADLimit(Lr) {
        if(Lr <= 0) return 1.0;
        let Lr_max = document.getElementById('cfg-level').value === "1" ? 0.8 : 1.5; // Level 1 is stricter
        if(Lr > Lr_max) return 0.0;
        
        if(document.getElementById('cfg-level').value === "1") {
            // Level 1: Box
            return 0.707; // Simplified rectangle
        } else {
            // Level 2: Curve
            let term1 = Math.sqrt((1 - 0.14*Lr*Lr)); // Plasticity correction part 1
            let term2 = (0.3 + 0.7 * Math.exp(-0.65 * Math.pow(Lr, 6)));
            return (1 - 0.14*Lr*Lr) * term2; // Actually BS7910 Eq is slightly different but this is the classic R6/BS form
        }
    }

    // --- MAIN LOOP ---
    function update() {
        // A. READ INPUTS
        const getV = (id) => parseFloat(document.getElementById('in-'+id).value);
        s.t = getV('t'); document.getElementById('disp-t').innerText = s.t.toFixed(1) + " mm";
        s.a = getV('a'); document.getElementById('disp-a').innerText = s.a.toFixed(1) + " mm";
        s.c = getV('2c')/2; document.getElementById('disp-2c').innerText = (s.c*2).toFixed(1) + " mm";
        s.W = 200; // Fixed W for simplicity in layout or add slider if needed
        s.sigy = getV('sigy'); document.getElementById('disp-sigy').innerText = s.sigy + " MPa";
        s.kmat = getV('kmat'); document.getElementById('disp-kmat').innerText = s.kmat + " MPa√m";
        s.sigm = getV('sigm'); document.getElementById('disp-sigm').innerText = s.sigm + " MPa";
        s.sigres = getV('sigres'); document.getElementById('disp-sigres').innerText = s.sigres + " MPa";
        s.dsig = getV('dsig'); document.getElementById('disp-dsig').innerText = s.dsig + " MPa";
        s.m = getV('m'); document.getElementById('disp-m').innerText = s.m.toFixed(2);

        // B. CURRENT STATUS CALCULATION
        let Y = calcY(s.a, s.c, s.t, s.W);
        
        // Lr (Reference Stress)
        // Sigma_ref = Sigma_m / (1 - Area_crack/Area_cross)
        let area_crack = (Math.PI * s.a * s.c) / 2;
        let area_cross = s.W * s.t;
        let net_ratio = 1.0 - (area_crack / area_cross);
        if(net_ratio < 0.05) net_ratio = 0.05;
        let sig_ref = s.sigm / net_ratio;
        let Lr = sig_ref / s.sigy;

        // Kr (Fracture)
        let K_prim = Y * s.sigm * Math.sqrt(Math.PI * (s.a/1000));
        let K_res = Y * s.sigres * Math.sqrt(Math.PI * (s.a/1000));
        let Kr = (K_prim + K_res) / s.kmat;

        // C. FATIGUE SIMULATION (Integration)
        let sim = runFatigue(Lr, Kr);

        // D. UPDATE UI
        updateDashboard(Lr, Kr, sim);
        updatePlots(Lr, Kr, sim);
    }

    function runFatigue(startLr, startKr) {
        let a = s.a;
        let N = 0;
        let hist_a = [a];
        let hist_N = [0];
        let hist_dK = [];
        let hist_rate = [];
        let traj_Lr = [startLr];
        let traj_Kr = [startKr];
        
        let max_a = s.t * 0.95; // Failure at through-wall
        let step = 0.2; // mm increment
        
        // Loop
        while(a < max_a && N < 2e7) {
            let Y = calcY(a, s.c, s.t, s.W); // Assume const c for simplicity or grow c
            
            // Check Criticality
            let area_crack = (Math.PI * a * s.c) / 2;
            let net_ratio = 1.0 - (area_crack / (s.W*s.t));
            let curr_sig_ref = s.sigm / Math.max(0.01, net_ratio);
            let curr_Lr = curr_sig_ref / s.sigy;
            
            let K_tot = (Y*(s.sigm + s.sigres)*Math.sqrt(Math.PI*(a/1000)));
            let curr_Kr = K_tot / s.kmat;
            
            // Store Trajectory
            traj_Lr.push(curr_Lr);
            traj_Kr.push(curr_Kr);
            
            // FAD Check
            if(curr_Kr > getFADLimit(curr_Lr)) break;

            // Fatigue Step
            let dK = Y * s.dsig * Math.sqrt(Math.PI*(a/1000));
            if(dK < s.dkth) dK = s.dkth; // Show threshold
            
            let dadN = s.C * Math.pow(dK, s.m);
            if(dadN < 1e-12) dadN = 1e-12; // Min speed
            
            hist_dK.push(dK);
            hist_rate.push(dadN * 1000); // mm/cycle

            let dN = (step/1000) / dadN;
            N += dN;
            a += step;
            
            hist_N.push(N);
            hist_a.push(a);
        }
        
        return { N_total: N, a_hist: hist_a, N_hist: hist_N, dK_hist: hist_dK, rate_hist: hist_rate, traj_Lr: traj_Lr, traj_Kr: traj_Kr };
    }

    function updateDashboard(Lr, Kr, sim) {
        // Values
        document.getElementById('kpi-lr').innerText = Lr.toFixed(2);
        document.getElementById('kpi-kr').innerText = Kr.toFixed(2);
        
        // FAD Limit Check
        let limitKr = getFADLimit(Lr);
        document.getElementById('kpi-kr-lim').innerText = "Limit: " + limitKr.toFixed(2);
        
        let passed = (Kr <= limitKr) && (Lr <= (document.getElementById('cfg-level').value==="1"?0.8:1.5));
        
        // Badge
        let badge = document.getElementById('status-badge');
        let txt = document.getElementById('status-text');
        if(passed) {
            badge.innerText = "PASS";
            badge.className = "badge pass";
            txt.innerText = "ACCEPTABLE";
            txt.style.color = "var(--success)";
        } else {
            badge.innerText = "FAIL";
            badge.className = "badge fail";
            txt.innerText = "CRITICAL";
            txt.style.color = "var(--danger)";
        }
        
        // Life
        let life = sim.N_total;
        let lifeStr = life > 1e7 ? ">10M" : (life/1e6).toFixed(2) + "M";
        document.getElementById('kpi-life').innerText = lifeStr + " cyc";
        
        // Next Inspection (Safety Factor 2 on Life)
        let insp = life * 0.5;
        let inspStr = insp > 1e7 ? ">5M" : (insp/1e6).toFixed(2) + "M";
        document.getElementById('kpi-next-insp').innerText = "Insp: " + inspStr + " cyc";
    }

    function initPlotly() {
        // FAD Layout
        Plotly.newPlot('plot-fad', 
            [{x:[0], y:[0]}], 
            {
                margin: {t:20, b:30, l:30, r:10},
                xaxis: {range:[0, 1.6], title: 'Lr'},
                yaxis: {range:[0, 1.2], title: 'Kr'},
                showlegend: false
            }, 
            {displayModeBar: false}
        );
        
        // Life Layout
        Plotly.newPlot('plot-life', [], {
            margin: {t:20, b:30, l:40, r:10},
            xaxis: {title: 'Cycles (N)'},
            yaxis: {title: 'Crack Depth a (mm)'}
        }, {displayModeBar: false});

        // Rate Layout
        Plotly.newPlot('plot-rate', [], {
            margin: {t:20, b:30, l:50, r:10},
            xaxis: {title: 'ΔK (MPa√m)', type: 'log'},
            yaxis: {title: 'da/dN (mm/cyc)', type: 'log'}
        }, {displayModeBar: false});
    }

    function updatePlots(Lr, Kr, sim) {
        // FAD Curve Construction
        let fadX = [], fadY = [];
        for(let i=0; i<=1.6; i+=0.05) {
            fadX.push(i);
            fadY.push(getFADLimit(i));
        }

        // 1. FAD PLOT (Instant Redraw)
        Plotly.react('plot-fad', [
            { x: fadX, y: fadY, mode: 'lines', name: 'Limit', line: {color:'#2d3436', width:2}},
            { x: [Lr], y: [Kr], mode: 'markers', marker: {size:12, color: (Kr>getFADLimit(Lr)?'#d63031':'#00b894')} },
            { x: sim.traj_Lr, y: sim.traj_Kr, mode: 'lines', line: {color:'#0984e3', dash:'dot', width:1} }
        ], {
            margin: {t:20, b:30, l:30, r:10},
            xaxis: {range:[0, 1.6], title: 'Lr'},
            yaxis: {range:[0, 1.2], title: 'Kr'},
            showlegend: false
        }, {displayModeBar: false});

        // 2. LIFE PLOT
        Plotly.react('plot-life', [
            { x: sim.N_hist, y: sim.a_hist, mode: 'lines', line: {color:'#0984e3', width:2} }
        ], {
            margin: {t:20, b:30, l:40, r:10},
            xaxis: {title: 'Cycles (N)'},
            yaxis: {title: 'Crack Depth a (mm)'}
        }, {displayModeBar: false});

        // 3. RATE PLOT
        Plotly.react('plot-rate', [
            { x: sim.dK_hist, y: sim.rate_hist, mode: 'lines', line: {color:'#d63031', width:2} }
        ], {
            margin: {t:20, b:30, l:50, r:10},
            xaxis: {title: 'ΔK (MPa√m)', type: 'log', autorange:true},
            yaxis: {title: 'da/dN (mm/cyc)', type: 'log', autorange:true}
        }, {displayModeBar: false});
    }

</script>
</body>
</html>
